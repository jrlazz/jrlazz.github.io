<!DOCTYPE html>
<html lang="en">
<head>
<title>ontv.html</title>
<meta charset="utf-8">
<link rel="shortcut icon" href="ok.ico"/>

<style>
@font-face {font-family:myq;src:url('../fonte/MysteryQuest-Regular.ttf');}
body{background-color:#024;color:#fc0;margin:0px;overflow:hidden;}
span{position:absolute;top:10px;width:100%;text-align:center;font-family:myq;font-weight:bold;font-size:16pt;color:#0ff;}
a{color:#0ff;text-decoration:none;font-size:10pt;cursor:pointer;}
button{position:absolute;left:0px;top:0px;width:100px;font-family:myq;font-weight:bold;background-color:transparent;text-align:center;color:#0ff;font-size:14pt;}
</style>

<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

<script type="importmap">
	{
		"imports":{
			"three":"https://unpkg.com/three@0.158.0/build/three.module.js",
			"three/addons/":"https://unpkg.com/three@0.158.0/examples/jsm/"
		}
	}
</script>

</head>

<body>

<video id="video" width="120" height="80" controls="" style="position:absolute;left:-120px;top:10px;"></video>

<canvas id="canvasRain" style="position:absolute;left:-10%;top:0px;background-color:transparent;width:10%;height:100%;display:none;">Canvas Not Supported</canvas>

<img src="img/GE_tr_2.png" style="width:10px;display:none;"></img>

<span style="left:75%;top:70%;width:300px;text-align:center">
<br>
<img src="img/music.png" style="width:40px;"></img>
<br>
<span style="position:relative;color:#fff;top:-3px;font-size:12pt;font-weight:normal;opacity:0.5;">Supergrass</span>
<br>
<audio id="audio" controls style="width:300px;opacity:0.5;display:none;"><source src="mp3/mute.mp3" type="audio/mpeg"></audio> 
</span>

<span style="left:1%;top:70%;width:300px;text-align:center">
<br>
<img src="img/music.png" style="width:40px;"></img>
<br>
<span style="position:relative;color:#fff;top:-3px;font-size:12pt;font-weight:normal;opacity:0.5;">Am&eacute;rico playing</span>
<br>
<audio id="audioA" controls style="width:300px;opacity:0.5;display:none;"><source src="mp3/mute.mp3" type="audio/mpeg"></audio> 
</span>

<span>Live on General Electric's 1957 (Model 14S208) portable TV</span>

<button style="left:20px;top:10px;width:120px;"><a id="code" href="ontv.txt" target="_blank" style="color:#fc0;text-decoration:none;font-size:16pt;">The Code</a></button>
<button id="pau" style="left:30px;top: 80px;">Freeze</button>
<button id="pla" style="left:30px;top:120px;">Run</button>
<button id="rain" style="left:30px;top:160px;">Rain</button>
<button id="norain" style="left:30px;top:200px;">No Rain</button>

<script type="module">

import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";

var renderer,scene,camera,ambient,controls;
var videoSettings,rawVideoStream,audioTrack,screen,screengeo,screentex,screenmat;
var textureLoader,indiogeo,indiotex,indiomat,GEgeo,loaderY,GEtex,GEmat,raintex,raingeo,rainmat;

var mesh=[];
var boxmat=[];

var sim=0;
var w=0;

var bId=function(id){return document.getElementById(id);}
var dpau=bId("pau");
var dpla=bId("pla");
var drain=bId("rain");
var dnorain=bId("norain");
var daudio=bId("audio");
var daudioA=bId("audioA");

THREE.ColorManagement.enabled=true;

function init(){

	dpau.onclick=function XPAU(){video.pause();}
	dpla.onclick=function XPLA(){video.play();}
	drain.onclick=function XRAIN(){scene.add(mesh[5]);scene.add(mesh[6]);}
	dnorain.onclick=function XNORAIN(){scene.remove(mesh[5]);scene.remove(mesh[6]);}

	renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
	renderer.setPixelRatio(window.devicePixelRatio);
	renderer.setSize(window.innerWidth,window.innerHeight);
	renderer.setClearColor('#063',0);
	renderer.outputColorSpace=THREE.SRGBColorSpace;

	document.body.appendChild(renderer.domElement);

	window.addEventListener('resize',onResize,false);

	scene=new THREE.Scene();

	camera=new THREE.PerspectiveCamera(40,window.innerWidth / window.innerHeight,1,1000);
	camera.position.set(0,0,150);

	controls=new OrbitControls(camera,renderer.domElement);
	controls.enableRotate=false;

	ambient=new THREE.AmbientLight(0xffffff,2);
	scene.add(ambient);

	textureLoader=new THREE.TextureLoader();

	indiogeo=new THREE.PlaneGeometry(45,40);
	indiotex=new THREE.TextureLoader().load("img/indio.png");
	indiomat=new THREE.MeshStandardMaterial({map:indiotex,transparent:true,side:THREE.DoubleSide});
	mesh[3]=new THREE.Mesh(indiogeo,indiomat);
	mesh[3].position.set(-22,2.3,-0.5);
	//mesh[3].rotation.set(0,0,-0.2);
	//scene.add(mesh[3]);


//https://neweraantiques.com/general-electric-model-14s208-1950s-two-tone-metal-portable-television-set-tv/

	//GEgeo=new THREE.BoxGeometry(98.5,69,10);
	loaderY=new THREE.TextureLoader();
	GEgeo=new THREE.PlaneGeometry(98.5,69);


	/*
    	boxmat=[
		new THREE.MeshStandardMaterial({map:loaderY.load('img/GE_tr_2.png'),transparent:true,side:THREE.DoubleSide}),
		new THREE.MeshStandardMaterial({map:loaderY.load('img/GE_tr_2.png'),transparent:true,side:THREE.DoubleSide}),
		new THREE.MeshStandardMaterial({map:loaderY.load('img/GE_tr_2.png'),transparent:true,side:THREE.DoubleSide}),
		new THREE.MeshStandardMaterial({map:loaderY.load('img/GE_tr_2.png'),transparent:true,side:THREE.DoubleSide}),
		new THREE.MeshStandardMaterial({map:loaderY.load('img/GE_tr_2.png'),transparent:true,side:THREE.DoubleSide}),
		new THREE.MeshStandardMaterial({map:loaderY.load('img/GE_tr_2.png'),transparent:true,side:THREE.DoubleSide})
	];
	*/

	//boxmat[4]=new THREE.MeshStandardMaterial({map:loaderY.load('img/GE_tr_2.png'),transparent:true,side:THREE.DoubleSide});

	GEtex=new THREE.TextureLoader().load("img/GE_tr_2.png");
	GEmat=new THREE.MeshStandardMaterial({map:GEtex,transparent:true,side:THREE.DoubleSide});
	mesh[4]=new THREE.Mesh(GEgeo,GEmat);
	mesh[4].position.set(0,5,0.5);
	mesh[1]=mesh[4].clone();
	mesh[1].position.set(0,5,-0.5);
	scene.add(mesh[1]);
	scene.add(mesh[4]);


	//https://dustinpfister.github.io/2018/04/17/threejs-canvas-texture/	

	raintex=new THREE.CanvasTexture(canvasRain);
	raintex.needsUpdate=true;
	raintex.wrapS=THREE.RepeatWrapping;raintex.wrapT=THREE.RepeatWrapping;
	raintex.repeat.set(3,1);
	raingeo=new THREE.PlaneGeometry(50,45);
	rainmat=new THREE.MeshStandardMaterial({map:raintex,transparent:true,side:THREE.DoubleSide});
	mesh[5]=new THREE.Mesh(raingeo,rainmat);
	mesh[5].position.set(-20,2.5,0.25);
	mesh[5].rotation.set(0,0,-0.1);
	mesh[6]=new THREE.Mesh(raingeo,rainmat);
	mesh[6].position.set(-20,2.5,-0.25);
	mesh[6].rotation.set(0,0,-0.1);

	navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(function(stream){
		rawVideoStream=stream;
		videoSettings=stream.getVideoTracks()[0].getSettings();
		audioTrack=stream.getAudioTracks()[0];
		let video=document.getElementById('video');
		Object.assign(video,{
			srcObject: stream,
			autoplay:true
		});
	});


//GE 1956

	screengeo=new THREE.PlaneGeometry(50,45);
	screentex=new THREE.VideoTexture(video);
	screentex.colorSpace=THREE.SRGBColorSpace;
	screenmat=new THREE.MeshStandardMaterial({map:screentex,side:THREE.DoubleSide});
	screen=new THREE.Mesh(screengeo,screenmat);
	screen.position.set(-20,2.5,0);
	screen.rotation.set(0,Math.PI,0.1);
	//scene.add(screen);

}

function onResize(){
	camera.aspect=window.innerWidth/window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(window.innerWidth,window.innerHeight);
}

function animate() {
	requestAnimationFrame(animate);
	if(videoSettings && screenmat && screen && sim==0){scene.add(screen);sim=1;}	
	if(raintex){raintex.needsUpdate=true;}
	if(sim==1){w++;}
	if(w==60){
		audio.src="mp3/supergrass.mp3";audio.volume=0.9;daudio.style.display="";
		audioA.src="mp3/AmLove.mp3";audioA.volume=0.9;daudioA.style.display="";
	}
	renderer.render(scene,camera);
}

init();

animate();

/*

Live on an old TV set, with webcam and animated canvas textures

Much based in video (mp4) as texture for a plane, and
partially based on https://eliashasle.github.io/ghost_webcam.html

the link:

https://jrlazz.eu5.org/anim/ontv.html

Three.js Forever !

Jose Roberto Lazzareschi ... jrlazz ... November, 27, 2023

*/

</script>

<script>

const ctx=document.querySelector("canvas").getContext("2d");
const numRain=320;

function render(time){
	time *= 0.001; // convert to seconds
  	resizeCanvasToDisplaySize(ctx.canvas);
  	const width=ctx.canvas.width;
	const height=ctx.canvas.height;
	ctx.fillStyle="transparent";
	ctx.fillRect(0,0,width,height);
	ctx.clearRect(0,0,width,height);  
  
	resetPseudoRandom();

	const speed=time*500;
	ctx.fillStyle="#0cc";
	ctx.strokeStyle="#0cc";
	for (let i=0; i<numRain; ++i){
		const x=pseudoRandomInt(width);
		const y=(pseudoRandomInt(height)+speed)%height;
		ctx.beginPath();
		ctx.ellipse(x,y,0.2,3,0,0,2*Math.PI,0);
		ctx.closePath();
		ctx.stroke();
		ctx.fill();
	}
	requestAnimationFrame(render);
}

requestAnimationFrame(render);

let randomSeed=0;

const RANDOM_RANGE_=Math.pow(2,32);

function pseudoRandom(){return (randomSeed_=(134775813*randomSeed_+1)%RANDOM_RANGE_)/RANDOM_RANGE_;};

function resetPseudoRandom(){randomSeed_=0;}

function pseudoRandomInt(n){return pseudoRandom()*n | 0;}

function resizeCanvasToDisplaySize(canvas) {
	const width=canvas.clientWidth;
	const height=canvas.clientHeight;
	if (canvas.width !== width || canvas.height !== height){canvas.width=width;canvas.height=height;}
}

function rainyes(){document.getElementById("canvasRain").style.display="";}

video.volume=0.7;

rainyes();

</script>

</body>

</html>
