<!DOCTYPE html>
<html lang="en">
<head>
<title>bloom5.html</title>
<meta charset="utf-8">
<link rel="shortcut icon" href="../ok.ico">
<style>
body{margin:0;background-color:#024;font-family:Lucida Console;font-size:9pt;color:#cff;overflow:hidden;}
</style>

</head>
<body>

<script type="importmap">
	{
		"imports":{
	"three":"https://unpkg.com/three@0.172.0/build/three.module.js",
	"three/addons/":"https://unpkg.com/three@0.172.0/examples/jsm/"
		}
	}
</script>

<script type="module">

import * as THREE from 'three';
import Stats from 'three/addons/libs/stats.module.js';
import { GUI } from 'three/addons/libs/lil-gui.module.min.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';
import { Line2 } from "three/addons/lines/Line2.js";
import { LineMaterial } from "three/addons/lines/LineMaterial.js";
import { LineGeometry } from "three/addons/lines/LineGeometry.js";
import { FontLoader} from 'three/addons/loaders/FontLoader.js';
import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';

var renderer, scene, camera, controls, loader, line, matLine, divs, color, spline, t, lineGeometry;
var stats, composer;
var point=new THREE.Vector3();
var pp=[];
var positions=[];
var color;
var w=0
var curvefactor=1;
var w=0;
var wW=window.innerWidth;
var wH=window.innerHeight;
var sub;
var opa=0;
var opb=0;
var line;
var text="FontLoader",bevelEnabled=false,font=undefined;
var geo,mat,mesh,depth=1,size=3,curveS=2,bevT=1,bevS=0.5;
var params={threshold:0,strength:1,radius:0,exposure:1};

	scene=new THREE.Scene();

	camera=new THREE.PerspectiveCamera(70,wW/wH,1,1000);
	camera.position.set(0,0,20);

	scene.add(camera);
	scene.add(new THREE.AmbientLight(0xcccccc));
	const pointLight=new THREE.PointLight(0xffffff,100);
	camera.add(pointLight);

	loader=new FontLoader();
	loader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json',function(response){font=response;createText();});
	mat=[new THREE.MeshStandardMaterial({color:'#f00',flatShading:true}),new THREE.MeshStandardMaterial({color:'#009'})];

	pp[0]=new THREE.Vector2(0,2);
	pp[1]=new THREE.Vector2(0,2);
	spline=new THREE.SplineCurve(pp);
	divs=curvefactor*(pp.length-1);
	point=new THREE.Vector3();
	for(let i=0;i<divs;i++){
		t=i/divs;
		spline.getPoint(t,point);
		positions.push(point.x,point.y,point.z);
	}
	matLine=new LineMaterial({color:0x009900,linewidth:14});
	matLine.resolution.set(wW,wH);
	lineGeometry=new LineGeometry();
	lineGeometry.setPositions(positions);
	line=new Line2(lineGeometry,matLine);
	line.computeLineDistances();
	
	renderer=new THREE.WebGLRenderer({antialias:true});
	renderer.setPixelRatio(window.devicePixelRatio);
	renderer.setSize(wW,wH);
	renderer.toneMapping=THREE.ReinhardToneMapping;
	document.body.appendChild(renderer.domElement);

	const renderScene=new RenderPass(scene,camera);

	const bloomPass=new UnrealBloomPass(new THREE.Vector2(wW,wH),1.5,0.4,0.85);
	bloomPass.threshold=params.threshold;
	bloomPass.strength=params.strength;
	bloomPass.radius=params.radius;

	const outputPass=new OutputPass();

	composer=new EffectComposer(renderer);
	composer.addPass(renderScene);
	composer.addPass(bloomPass);
	composer.addPass(outputPass);

	stats=new Stats();
	document.body.appendChild(stats.domElement);

	controls=new OrbitControls(camera,renderer.domElement);

	const gui=new GUI();
	const bloomFolder=gui.addFolder('bloom');
	bloomFolder.add(params, 'threshold', 0.0, 1.0).onChange(function (value) {	bloomPass.threshold=Number(value);	});
	bloomFolder.add(params, 'strength', 0.0, 3.0).onChange(function (value) {bloomPass.strength=Number(value);});
	gui.add(params, 'radius', 0.0, 1.0).step(0.01).onChange(function (value) {bloomPass.radius=Number(value);});
	const toneMappingFolder=gui.addFolder('tone mapping');
	toneMappingFolder.add(params, 'exposure', 0.1, 2).onChange(function (value) {renderer.toneMappingExposure=Math.pow(value, 4.0);});
	window.addEventListener('resize', onWindowResize);

function createText() {
	geo=new TextGeometry(text,{
	font:font,size:size,depth:depth,
	curveSegments:curveS,
	bevelThickness:bevT,bevelSize:bevS,bevelEnabled:bevelEnabled});
	geo.computeBoundingBox();
	mesh=new THREE.Mesh(geo,mat);
	mesh.position.set(-9,5,0);
	scene.add(mesh);
}

function onWindowResize(){
	const width=window.innerWidth;
	const height=window.innerHeight;
	camera.aspect=width/height;
	camera.updateProjectionMatrix();
	renderer.setSize(width,height);
	composer.setSize(width,height);
}

function animate(){
	requestAnimationFrame(animate);
	if(line){line.rotation.y -=0.01;}
	if(controls){controls.update();}
	renderer.render(scene,camera);
	stats.update();
	composer.render();
	if(line){
		w++;
		if(w<300){
			scene.remove(line);
			opa++;
			positions.push(opa/20,2*Math.cos(opa/6),0);
			lineGeometry=new LineGeometry();
			lineGeometry.setPositions(positions);
			line=new Line2(lineGeometry,matLine);
			line.computeLineDistances();
			line.position.set(-10,0,0);
			scene.add(line);
		}
	}
}

animate();

</script>
</body>
</html>
