<!DOCTYPE html>
<html lang="en">
<head>
<title>movealongD.html</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
<link rel="shortcut icon" href="../ok.ico">

<style>
body{margin:0;background-color:#000;font-family:Monospace;font-size:9pt;color:#cff;overflow:hidden;}
</style>

<script type="importmap">
	{
	  "imports": {
		"three": "https://unpkg.com/three@0.171.0/build/three.module.min.js",
		"three/addons/": "https://unpkg.com/three@0.171.0/examples/jsm/"
	  }
	}
</script>
</head>

<body>

<img id="bi" src="img/moto2.jpg" style="position:absolute;left:10px;top:5px;width:200px;;border:2px solid #0ff;cursor:pointer;"></img>
<span style="position:absolute;left:32px;top:135px;color:#0ff;">You may click on image</span>
<a href="movealongD.txt" target="_blank" class="bu" style="position:absolute;left:80%;top:10px;width:200px;background-color:#066;color:#0ff;text-align:center;text-decoration:none;border:2px outset #0ff;">View code</a>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
//import Stats from 'three/addons/libs/stats.module.js';
import { Flow } from 'three/addons/modifiers/CurveModifier.js';
import { STLLoader } from 'three/addons/loaders/STLLoader.js';
import { SVGLoader } from 'three/addons/loaders/SVGLoader.js';

const ACTION_SELECT=1, ACTION_NONE=0;
const curveHandles=[];
const mouse=new THREE.Vector2();

var stats;
var scene,camera,renderer,loader,geometry,material,controls,geo,mat,action=ACTION_NONE;
var flow=[];
var somePoints,curve,objectToCurve;
var sim=0,pim=0;
var k=0.0322,kk=0.0322;

var woo=[], g=[], l=[], m=[], s=[], ss=[], f=[];
var pts, curve, points, line, light; 
var gro=[];for(let z=1;z<300;z++){gro[z]=new THREE.Group();}
var PP=Math.PI*2;
var v=1;
var rot=0.0005;

var paths=[],shapes=[],dep=2,cur=10;

var dbi=document.getElementById("bi");

	dbi.onclick=function BI(){
		for(let z=1;z<125;z++){if(flow[z]){scene.remove(flow[z].object3D);}}
		flow=[];
		st();
		s[102].rotation.z=0.26;scene.add(s[103]);v=1-v;
	}

	scene=new THREE.Scene();

	camera=new THREE.PerspectiveCamera(40,window.innerWidth/window.innerHeight,1,1000);
	//camera.position.set(4,2,2);
	camera.position.set(0,3,3);
	//camera.lookAt(scene.position);

	somePoints=[
		new THREE.Vector3(-1.4, 0.33,0),
		new THREE.Vector3(-1.6,    0,0),
		new THREE.Vector3(-1.4,-0.33,0),
			new THREE.Vector3(0,-0.65,0),
		new THREE.Vector3(2.04,-0.6,0),
		new THREE.Vector3(2.36,    0,0),
		new THREE.Vector3(2.04, 0.6,0),
			new THREE.Vector3(0,0.57,0),
	];

	pts=new THREE.Points(new THREE.BufferGeometry().setFromPoints(somePoints),new THREE.PointsMaterial({color:'#f00',size:0.1}));
	scene.add(pts);

	curve=new THREE.CatmullRomCurve3(somePoints);
	curve.curveType='centripetal';
	curve.closed=true;

	points=curve.getPoints(80);
	line=new THREE.LineLoop(
		new THREE.BufferGeometry().setFromPoints(points),
		new THREE.LineBasicMaterial({color:'#fff'})
	);

	scene.add( line );

	l[1]=new THREE.AmbientLight('#fff',40);
	scene.add(l[1]);
	l[2]=new THREE.PointLight('#fff',2000);
	l[2].position.set(10,3,-5);
	scene.add(l[2]);
	l[3]=new THREE.PointLight('#fff',6000);
	l[3].position.set(0,15,0);
	scene.add(l[3]);
	l[4]=new THREE.PointLight('#fff',1000);
	l[4].position.set(-10,0,16);
	scene.add(l[4]);

// ******** ******** Axes & extras
	g[1]=new THREE.CylinderGeometry(0.04,0.04,0.3);
	m[1]=new THREE.MeshStandardMaterial({color:'#055',metalness:0.9,roughness:0.2});
	s[1]=new THREE.Mesh(g[1],m[1]);
	s[1].rotation.set(Math.PI/2,0,0);
	s[1].position.set(-1.25,0,0);
	scene.add(s[1]);
		s[2]=s[1].clone();
		s[2].scale.set(2,1,2);
		s[2].position.set(1.66,0,0);
		scene.add(s[2]);
	g[43]=new THREE.CylinderGeometry(0.25,0.25,0.05);
	m[43]=new THREE.MeshStandardMaterial({color:'#055',metalness:0.9,roughness:0.2});
	s[43]=new THREE.Mesh(g[43],m[43]);
	s[43].rotation.set(Math.PI/2,0,0);
	s[43].position.set(-1.25,0,0);
	scene.add(s[43]);

// ******** ******** STLs
function st(){
	loader=new STLLoader();
	loader.load( 'models/extras/chainC.stl',function(geometry){
		geometry.scale(0.015,0.015,0.015)
		material=new THREE.MeshStandardMaterial({color:'#900',metalness:0.9,roughness:0.2});
		objectToCurve=new THREE.Mesh(geometry,material);
		for(let z=1;z<62;z=z+2){
			flow[z]=new Flow(objectToCurve);
			flow[z].updateCurve(0,curve);
			scene.add(flow[z].object3D);
			flow[z].moveAlongCurve(0.016+k);
			k=k+kk;
		}
	} );
	loader.load('models/extras/chainB.stl',function(geometry){
		geometry.scale(0.015,0.015,0.015)
		material=new THREE.MeshStandardMaterial({color:'#06c',metalness:0.9,roughness:0.2,transparent:false,opacity:0.5});
		geo=geometry.clone();
		mat=material.clone();
		objectToCurve=new THREE.Mesh(geo,mat);
		k=kk;
		for(let z=2;z<63;z=z+2){
			flow[z]=new Flow(objectToCurve);
			flow[z].updateCurve(0,curve);
			scene.add(flow[z].object3D);
			flow[z].moveAlongCurve(k);
			k=k+kk;
		}
	});
	loader.load('models/extras/chainD.stl',function(geometry){
		geometry.scale(0.015,0.015,0.015)
		material=new THREE.MeshStandardMaterial({color:'#090',metalness:0.9,roughness:0.2});
		geo=geometry.clone();
		mat=material.clone();
		objectToCurve=new THREE.Mesh(geo,mat);
		k=kk;
		for(let z=64;z<125;z=z+2){
			flow[z]=new Flow(objectToCurve);
			flow[z].updateCurve(0,curve);
			scene.add(flow[z].object3D);
			flow[z].moveAlongCurve(0.016+k);
			k=k+kk;
		}
	});
}

st();

// ******** ******** Gears
	loader=new SVGLoader();
	m[102]=[new THREE.MeshStandardMaterial({color:'#055',metalness:0.9,roughness:0.2}),new THREE.MeshStandardMaterial({color:'#600',metalness:0.9,roughness:0.2})];
	loader.load('img/hd15m.svg',function(data){
		paths=data.paths;
		shapes=SVGLoader.createShapes(paths[0]);
		g[102]=new THREE.ExtrudeGeometry(shapes[0],{depth:26,curveSegments:cur});
		s[102]=new THREE.Mesh(g[102],m[102]);
		s[102].position.set(-1.25,0,-0.024);
		s[102].rotation.set(0,0,Math.PI/2);
		s[102].scale.setScalar(0.0018);
		s[102].rotation.z=0.26;
		scene.add(s[102]);
	})
	loader.load('img/hd30m.svg',function(data){
		paths=data.paths;
		shapes=SVGLoader.createShapes(paths[0]);
		g[103]=new THREE.ExtrudeGeometry(shapes[0],{depth:0.7,curveSegments:cur});
		s[103]=new THREE.Mesh(g[103],m[102]);
				s[103].position.set(1.68,0,-0.02);
		s[103].rotation.set(0,0,Math.PI/2);
		s[103].scale.setScalar(0.042);
		s[103].rotation.z=0.32;
		scene.add(s[103]);
	})

// ******** ********

	renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
	renderer.setClearColor(0x222222,0);
	renderer.setPixelRatio(window.devicePixelRatio);
	renderer.setSize( window.innerWidth,window.innerHeight);
	document.body.appendChild(renderer.domElement);
	window.addEventListener('resize',onWindowResize);
	controls=new OrbitControls(camera,renderer.domElement);

function onWindowResize(){
	camera.aspect=window.innerWidth/window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(window.innerWidth,window.innerHeight);
}

function animate(){
	requestAnimationFrame(animate);
	if(v==1){
		if(flow[1] && flow[2] && flow[64]){
			for(let z=1;z<62;z=z+2){  flow[z].moveAlongCurve(rot);}
			for(let z=2;z<63;z=z+2){  flow[z].moveAlongCurve(rot);}
			for(let z=64;z<125;z=z+2){flow[z].moveAlongCurve(rot);}
		}
		if(s[102]){s[102].rotation.z +=(rot*11*2.444);}
		if(s[103]){s[103].rotation.z +=rot*12.96;}
	}else{
		if(flow[1] && flow[2] && flow[64]){
			for(let z=1;z<62;z=z+2){  flow[z].moveAlongCurve(rot*3);}
			for(let z=2;z<63;z=z+2){  flow[z].moveAlongCurve(rot*3);}
			for(let z=64;z<125;z=z+2){flow[z].moveAlongCurve(rot*3);}
		}
		if(s[102]){s[102].rotation.z +=(rot*11*2.444)*3;}
		if(s[103]){s[103].rotation.z +=(rot*12.96)*3;}
	}
	
	renderer.render(scene,camera);
}

animate();

</script>

</body>
</html>
