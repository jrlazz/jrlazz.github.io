<!DOCTYPE html>
<html lang="en">
<head>
<title>makegear.html</title>
<meta charset="utf-8" />
<link rel="shortcut icon" href="../ok.ico">

<style>
body{margin:0;background-color:#000;font-family:Lucida Console;font-size:9pt;color:#cff;overflow:hidden;}
td{font-size:12pt;}
</style>

<script type="importmap">
{"imports": {"three": "https://cdn.jsdelivr.net/npm/three@0.172.0/build/three.module.min.js",
"three/addons/": "https://cdn.jsdelivr.net/npm/three@0.172.0/examples/jsm/"}}
</script>

</head>

<body>
<span style="position:absolute;left:80%;width:20%;top:120px;font-size:20.5px;font-weight:bold;color:#0fc;text-align:center;">
Gear Making<br>
</span>

<table style="position:absolute;left:10px;top:10px;">
<tr><td>teeth number:</td><td><input id="tn" type="number" value="15" min="8" max="128" step="1" autocomplete="off" style="width:60px;text-align:center;font-weight:bold;font-size:13pt;"></input></td><td></td></tr>
<tr><td>teeth distance:</td><td><input id="td" type="range" value="0.204" min="0.1" max="2" step="0.001" autocomplete="off" style="width:210px;"></input></td><td><span id="_tdval">0.204</span></td></tr>
<tr style="display:none;"><td>tooth size:</td><td><input id="ts" type="range" value="0.002" min="0.0001" max="0.01" step="0.0001" autocomplete="off" style="width:210px;"></input></td><td><span id="_tsval">0.002</span></td></tr>
<tr><td>gear size:</td><td><input id="gs" type="range" value="1.5" min="0.5" max="3" step="0.01" autocomplete="off" style="width:210px;"></input></td><td><span id="_gsval">1.5</span></td></tr>
<tr><td>gear depth:</td><td><input id="gd" type="range" value="1" min="0.1" max="3" step="0.01" autocomplete="off" style="width:210px;"></input></td><td><span id="_gdval">1</span></td></tr>
<tr><td>gear filler:</td><td><input id="gf" type="range" value="1.2" min="0.2" max="8" step="0.1" autocomplete="off" style="width:210px;"></input></td><td><span id="_gfval">1.2</span></td></tr>
<tr><td>gear rotation:</td><td><input id="gr" type="range" value="0.01" min="0" max="0.06" step="0.001" autocomplete="off" style="width:210px;"></input></td><td><span id="_grval">0.001</span></td></tr>
<tr><td>show axe:</td><td><input id="ga" type="checkbox" checked="true" autocomplete="off" style="width:20px;height:20px"></input></td><td></td></tr>
</table>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { SVGLoader } from 'three/addons/loaders/SVGLoader.js';
import { STLExporter } from 'three/addons/exporters/STLExporter.js';
import { GUI } from 'three/addons/libs/lil-gui.module.min.js';

var stats;
var scene,camera,renderer,loader,geometry,material,controls,link,exporter,result;

var k=0.0322,kk=0.0322;
var paths=[],shapes=[];
var ax=[];for(let z=1;z<100;z++){ax[z]=new THREE.AxesHelper(0.001);}
var g=[], l=[], m=[], s=[];
var gro=[];for(let z=1;z<100;z++){gro[z]=new THREE.Group();}
var groupmesh=new THREE.Group();
var PP=Math.PI*2;
var muda=0;

const params={exportASCII:exportASCII,exportBinary:exportBinary};

var bId=function(id){return document.getElementById(id);}
var dtn=bId("tn");	var dtd=bId("td");	var dts=bId("ts");	var dgs=bId("gs");	var dgd=bId("gd");	var dgr=bId("gr");	var dgf=bId("gf");	var dga=bId("ga");
var dtnval=bId("td");	var dtdval=bId("td");	var dtsval=bId("ts");	var dgsval=bId("gs");
var d_tdval=bId("_tdval");	var d_tsval=bId("_tsval");	var d_gsval=bId("_gsval");	var d_gdval=bId("_gdval");	var d_gfval=bId("_gfval"); var d_grval=bId("_grval");

	dtn.onchange=function(){muda=1;}
	dtd.onchange=function(){muda=1;}
	dts.onchange=function(){muda=1;}
	dgs.onchange=function(){muda=1;}
	dgd.onchange=function(){muda=1;}
	dgf.onchange=function(){muda=1;}
	dgr.onchange=function(){muda=1;}
	dga.onchange=function(){muda=1;}

	scene=new THREE.Scene();

	camera=new THREE.PerspectiveCamera(20,window.innerWidth/window.innerHeight,1,1000);
	camera.position.set(-2,1,3);
	//camera.position.set(0,0,3);
	camera.lookAt( scene.position );

	exporter=new STLExporter();

	l[1]=new THREE.AmbientLight('#fff',5);
	scene.add(l[1]);
	l[2]=new THREE.PointLight('#fff',2000);
	l[2].position.set(-10,5,-25);
	scene.add(l[2]);

// ******** Central Axe
	g[1]=new THREE.CylinderGeometry(0.02,0.02,0.4);
	m[1]=new THREE.MeshStandardMaterial({color:'#f66',metalness:0.9,roughness:0.2});
	s[1]=new THREE.Mesh(g[1],m[1]);
	s[1].rotation.set(Math.PI/2,0,0);
	s[1].position.set(0,0,0.03);
	scene.add(s[1]);

// ******** Gear
	loader=new SVGLoader();
	m[2]=[new THREE.MeshStandardMaterial({color:'#099',metalness:0.7,roughness:0.2}),new THREE.MeshStandardMaterial({color:'#c33',metalness:0.7,roughness:0.2})];
	loader.load('img/tooth18f.svg',function(data){
		paths=data.paths;
		shapes=SVGLoader.createShapes(paths[0]);
		g[2]=new THREE.ExtrudeGeometry(shapes[0],{depth:32,bevelEnabled:false,curveSegments:50});
		s[2]=new THREE.Mesh(g[2],m[2]);
		s[2].position.set(0,0.204,0);
		s[2].rotation.set(0,0,Math.PI);
		s[2].scale.setScalar(0.002);
		ax[2].add(s[2]);
		let a=0;let fi=16;
		for(let z=a;z<fi;z++){
			a=a+PP/(fi-1);
			ax[z]=ax[2].clone();
			ax[z].rotation.set(0,0,a);
			gro[2].add(ax[z]);
		}
		gro[2].scale.set(1.5,1.5,1);
	})
	loader.load('img/circle.svg',function(data){
		paths=data.paths;
		shapes=SVGLoader.createShapes(paths[0]);
		g[3]=new THREE.ExtrudeGeometry(shapes[0],{depth:32,bevelEnabled:false,curveSegments:30});
		s[3]=new THREE.Mesh(g[3],m[2]);
		s[3].position.set(0,0,0);
		s[3].rotation.set(0,0,Math.PI);
		s[3].scale.setScalar(0.002);
		gro[3].add(s[3]);
		gro[3].scale.set(1.2,1.2,1);
	})

	groupmesh.add(gro[2]);
	groupmesh.add(gro[3]);
	groupmesh.add(s[1]);
	scene.add(groupmesh);

// ******** Render

	renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
	renderer.setClearColor(0x222222,0);
	renderer.setPixelRatio(window.devicePixelRatio);
	renderer.setSize( window.innerWidth,window.innerHeight);
	document.body.appendChild(renderer.domElement);
	window.addEventListener('resize',onWindowResize);
	controls=new OrbitControls(camera,renderer.domElement);

	link=document.createElement('a');
	link.style.display='none';
	document.body.appendChild(link);

	const gui=new GUI();
	gui.add(params,'exportASCII').name('Export STL(ASCII)');
	gui.add(params,'exportBinary').name('Export STL(Binary)');
	gui.open();

function exportASCII(){result=exporter.parse(groupmesh);saveString(result,'gear_ascii.stl');}
function exportBinary(){result=exporter.parse( groupmesh,{binary:true});saveArrayBuffer(result,'gear_bin.stl');}
function save(blob,filename){link.href=URL.createObjectURL(blob);link.download=filename;link.click();}
function saveString(text,filename){save(new Blob([text],{type:'text/plain'}),filename);}
function saveArrayBuffer(buffer,filename){save(new Blob([buffer],{type:'application/octet-stream'}),filename);}
function onWindowResize(){
	camera.aspect=window.innerWidth/window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(window.innerWidth,window.innerHeight);
}

function animate(){
	requestAnimationFrame(animate);

	if(muda==1){
		groupmesh.remove(gro[2]);
		groupmesh.remove(gro[3]);
		scene.remove(s[1]);

		s[1].position.z=dgd.value/32;
		scene.remove(gro[2]);
		scene.remove(gro[3]);
			scene.remove(s[1]);
		s[2].position.set(0,td.value,0);d_tdval.innerText=dtd.value;
		s[2].scale.set(0.002,dts.value,0.002);d_tsval.innerText=dts.value;
						ax[2]=new THREE.AxesHelper(0.001);
		ax[2].add(s[2]);
		let a=0;
		let fi=eval(dtn.value)+1;
						gro[2]=new THREE.Group();
		for(let z=a;z<fi;z++){
			a=a+PP/(fi-1);
			ax[z]=ax[2].clone();
			ax[z].rotation.set(0,0,a);
			gro[2].add(ax[z]);
		}
		gro[2].scale.set(dgs.value,dgs.value,dgd.value);d_gsval.innerText=dgs.value;d_gdval.innerText=dgd.value;
		gro[3].scale.set(dgf.value,dgf.value,dgd.value);d_gfval.innerText=dgf.value;

		scene.add(gro[2]);
		scene.add(gro[3]);
		gro[2].rotation.z -=(dgr.value);d_grval.innerText=dgr.value;
		muda=0;

		groupmesh.add(gro[2]);
		groupmesh.add(gro[3]);
		scene.add(groupmesh);

		if(dga.checked==true){
			scene.add(s[1]);groupmesh.add(s[1]);
		}else{
			scene.remove(s[1]);groupmesh.remove(s[1]);
		}

	}

	gro[2].rotation.z -=(dgr.value);

	renderer.render(scene,camera);
}

animate();

</script>

</body>
</html>
