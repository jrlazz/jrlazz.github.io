<!DOCTYPE html>
<html lang="en">
<head>
<title>voice.html</title>
<meta charset="utf-8">
<link rel="shortcut icon" href="../r90/examples/ok.ico" />
<style>
body{margin:0px;border:none;background-color:#036;font-family:Monospace;overflow:hidden;}
</style>

<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

<script type="importmap">
	{
		"imports":{
			"three":"https://unpkg.com/three@0.156.0/build/three.module.js",
			"three/addons/":"https://unpkg.com/three@0.156.0/examples/jsm/"
		}
	}
</script>

</head>

<body>

<a id="code" href="voice.txt" target="_blank" style="position:absolute;left:10px;top:10px;color:#fc0;text-decoration:none;font-size:16pt;">The Code</a>

<center>
<span id="ding" style="display:;position:relative;top:30px;font-size:41pt;padding:4px;color:#f00;">...&nbsp;Loading&nbsp;...</span>
<button id="bostart" style="display:none;position:relative;top:30px;font-size:41px;padding:4px;background-color:#fc0;color:#009;cursor:pointer;">&nbsp;&nbsp;Click&nbsp;To&nbsp;Start&nbsp;&nbsp;</button>
<button id="bo" style="display:none;position:relative;top:30px;font-size:41px;padding:4px;background-color:#fc0;color:#000;cursor:pointer;">&nbsp;Play&nbsp;/&nbsp;Pause&nbsp;</button></center>
</center>

<span style="position:absolute;left:10px;top:60px;text-align:center;">
<input id="volin" type="range" style="display:none;font-size:14pt;width:100px;cursor:pointer;" value="0.4" min="0" max="1" step="0.02" autocomplete="off"></input>
<br><span id="spanB" style="display:none;color:#fc0;font-size:14pt;"></span>
</span>

<script type="module">

import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { DDSLoader } from 'three/addons/loaders/DDSLoader.js';
import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';
import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
import { STLLoader } from 'three/addons/loaders/STLLoader.js';

var scene,camera,renderer,analyser,uniforms,controls,texture,texture2;

var box=[];
var geo=[];
var mat=[];

var w=0;
var currentTime;
var volval=document.getElementById("volin");
var gainNode, audio;

var CA;

var ww=0;
var str="";

var mesh=[];
var p=Math.PI;

var tex=[];
var marca=[];
var luz=[];

var sim=0;
var audioloaded=0;

var start=document.getElementById('bostart');start.onclick=function StartAnimation(){init();}
var inpA=document.getElementById('volin');inpA.onchange=function StartAnimation(){mudavol();}

function init() {

	document.getElementById("bostart").style.display="none";
	document.getElementById("bo").style.display="";
	document.getElementById("volin").style.display="";
	document.getElementById("spanB").style.display="";

	renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
	renderer.setSize( window.innerWidth,window.innerHeight);
	renderer.setPixelRatio(window.devicePixelRatio);
	renderer.outputColorSpace=THREE.LinearSRGBColorSpace;

	document.body.appendChild(renderer.domElement);
	scene=new THREE.Scene();
	camera=new THREE.PerspectiveCamera(90,window.innerWidth/window.innerHeight,1,1000);
	camera.position.set(0,150,300);

	luz[1]=new THREE.AmbientLight('#fff',2);
	scene.add(luz[1]);

	luz[2]=new THREE.PointLight('#fff',10000);
	luz[2].position.set(0,100,150);
	scene.add(luz[2]);

	luz[3]=new THREE.PointLight('#fff',40000);
	luz[3].position.set(-100,200,0);
	scene.add(luz[3]);

	luz[4]=new THREE.PointLight('#fff',40000);
	luz[4].position.set(100,200,0);
	scene.add(luz[4]);

	geo[0]=new THREE.BoxGeometry(2,0.5,5);
	mat[0]=new THREE.MeshStandardMaterial({color:0xffffff});
	box[0]=new THREE.Mesh(geo[0],mat[0]);

	tex[1]=new THREE.TextureLoader().load('../r90/examples/img/r1kHz.png');
	tex[2]=new THREE.TextureLoader().load('../r90/examples/img/r2kHz.png');
	tex[4]=new THREE.TextureLoader().load('../r90/examples/img/r4kHz.png');
	tex[8]=new THREE.TextureLoader().load('../r90/examples/img/r8kHz.png');
	tex[10]=new THREE.TextureLoader().load('../r90/examples/img/r10kHz.png');

	for(let m=1;m<11;m++){
		if(tex[m]){marca[m]=new THREE.MeshStandardMaterial({map:tex[m],transparent:true,opacity:0.7});}
	}

	for(let m=1;m<11;m++){
		if(marca[m]){box[600+m]=new THREE.Mesh(geo[0],marca[m]);}
	}

	box[601].position.set(-334,25,1);box[601].scale.set(1,500,5);scene.add(box[601]);
	box[602].position.set(-274,25,1);box[602].scale.set(1,500,5);scene.add(box[602]);
	box[604].position.set(-144,25,1);box[604].scale.set(1,500,5);scene.add(box[604]);
	box[608].position.set( 114,25,1);box[608].scale.set(1,500,5);scene.add(box[608]);
	box[610].position.set( 240,25,1);box[610].scale.set(1,500,5);scene.add(box[610]);

	for(let z=1;z<129;z++){
		geo[z]=geo[0].clone();
		mat[z]=new THREE.MeshStandardMaterial({color:'hsl('+z*2+',90%,50%)'});
		box[z]=new THREE.Mesh(geo[z],mat[z]);
		box[z].scale.set(2,1,10);
		box[z].position.x=-400+z*6;
		scene.add(box[z]);
	}

	controls=new OrbitControls(camera,renderer.domElement);

	audio=new Audio();
	audio.src="../r90/examples/mp3/voices.mp3";//"../r90/examples/mp3/124810.mp3";
	audio.load();
	//audio.play();

	var duration=0;
	window.AudioContext=window.AudioContext||window.webkitAudioContext; // old safari trick
	var audioContext=new AudioContext();
	analyser=audioContext.createAnalyser();

	var masterGain=audioContext.createGain();
	masterGain.connect(audioContext.destination);
	gainNode=audioContext.createGain();
	gainNode.connect(masterGain);
	gainNode.connect(audioContext.destination);
	gainNode.gain.value=0.4;
	var source=audioContext.createMediaElementSource(audio);
	source.connect(analyser);
	source.connect(gainNode);
	audio.volume=0.9;
	document.getElementById("bo").style.display="block";
	duration=audio.duration;

	document.getElementById("bo").addEventListener("click",function(){
		if(audio.paused){
			audio.play();scene.add(mesh[3]);scene.remove(mesh[4]);
		}else{
			audio.pause();
		}
	})

	audio.addEventListener("ended",function(){scene.add(mesh[4]);scene.remove(mesh[3]);})
	audio.onloadeddata=function(){audioloaded=1;}

	window.addEventListener('resize',onWindowResize);

	gainNode.gain.value=volval.value;

	geo[1]=new THREE.CircleGeometry(12,16);
	mat[1]=new THREE.MeshStandardMaterial({color:'#900'});//side:THREE.DoubleSide
	mesh[1]=new THREE.Mesh(geo[1],mat[1]);
	mesh[1].rotation.set(0,0,0);

	geo[2]=new THREE.RingGeometry(12,14,16);
	mat[2]=new THREE.MeshStandardMaterial({color:'#f00'});
	mesh[2]=new THREE.Mesh(geo[2],mat[2]);
	mesh[2].rotation.set(0,0,0);

	mesh[2].add(mesh[1]);

	var textureLoader=new THREE.TextureLoader();
	texture=textureLoader.load('../r90/examples/models/steve/Steve_f_0.png');
	texture2=textureLoader.load('../r90/examples/models/steve/Steve_f_1.png');
	
	geo[3]=new THREE.PlaneGeometry(100,100);
	mat[3]=new THREE.MeshStandardMaterial({map:texture});
	mesh[3]=new THREE.Mesh(geo[3],mat[3]);
	mesh[3].rotation.set(0,0,0);
	//mesh[3].position.set(0.1,75,49.9);

	mesh[2].scale.y=0.1;
	mesh[2].scale.x=1.5;
	mesh[2].position.set(0,-36,2);

	mesh[3].add(mesh[2]);

	mesh[3].scale.multiplyScalar(1);

	mesh[3].position.set(0.1,120,49.9);

	scene.add(mesh[3]);

	geo[4]=new THREE.PlaneGeometry(100,100);
	mat[4]=new THREE.MeshStandardMaterial({map:texture2});
	mesh[4]=new THREE.Mesh(geo[4],mat[4]);
	mesh[4].rotation.set(0,0,0);
	mesh[4].position.set(0.1,120,50.2);

	var onProgress=function(xhr){
		if(xhr.lengthComputable){
			var percentComplete=xhr.loaded/xhr.total*100;
			console.log(Math.round(percentComplete,2)+'% downloaded');
		}
	};
	var onError=function(xhr){};

	var mtlLoader=new MTLLoader();
	var objLoader=new OBJLoader();
	var k=0;
	var setpat='../r90/examples/models/steve/';
	mtlLoader.setPath(setpat);mtlLoader.load('partesfoscas.mtl',function(materials){materials.preload();objLoader.setMaterials(materials);objLoader.setPath(setpat);objLoader.load('steve_ca.obj',function(object){CA=object;CA.scale.multiplyScalar(50);CA.position.set(0,70,-2);scene.add(CA);},onProgress,onError);});


	geo[5]=new THREE.PlaneGeometry(100,100);
	mat[5]=new THREE.MeshStandardMaterial({color:'#fff'});
	mesh[5]=new THREE.Mesh(geo[5],mat[5]);
	mesh[5].rotation.set(0,0,0);
	mesh[5].position.set(0.1,75,50.2);
	//scene.add(mesh[5]);

	animate();

}

function onWindowResize(){
	camera.aspect=window.innerWidth/window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(window.innerWidth,window.innerHeight);
}

function mudavol(){
	gainNode.gain.value=volval.value;
	document.getElementById("spanB").innerText="gain= "+volval.value;
}
function mudagain(){
	gainNode.gain.value=volgain.value;
	document.getElementById("spanA").innerText="gain= "+volgain.value;
}

function animate(){
	requestAnimationFrame(animate);

	if(sim==0 && audioloaded==1 && mesh[4] && CA){audio.play();sim=1;}

	if(analyser){
		function getDataFromAudio(){
			analyser.fftSize=512;
			var freqByteData=new Uint8Array(analyser.fftSize/2);
			var timeByteData=new Uint8Array(analyser.fftSize/2);
			analyser.getByteFrequencyData(freqByteData);
			analyser.getByteTimeDomainData(timeByteData);
			return{f:freqByteData,t:timeByteData};// array of all 1024 levels
		}

		var data=[];
		data=getDataFromAudio();
		var ff=[];ff=data.f;var tt=[];tt=data.t;
 		for (let j=1;j<129;j++){
			if(ff[j]*2>20 && j<65){mesh[2].scale.y=ff[j]/220;}//document.getElementById("indi").innerText=ff[j]*2;
			box[j].scale.y=ff[j];
			if(j<129){box[j].position.y=-100+(ff[j]/4);}
		}
	}
	renderer.render(scene,camera);
}

document.getElementById("spanB").innerText="gain= "+volval.value;

var myTimeout=setTimeout(myTime,3000);
function myTime(){
	document.getElementById("bostart").style.display="";
	document.getElementById("ding").style.display="none";
}

var mika=42;
var moka=-1;
var myInterval=setInterval(myVal,60);
function myVal(){
	mika=mika-1;
	moka++;
	document.getElementById("ding").style.fontSize=mika+"pt";
	document.getElementById("ding").style.color="hsl("+moka*9+",100%,50%)";
	if(mika<4){clearInterval(myInterval);}
}

/*

Voices, lip and mouth movements

An experience...

I was inspired by the recent work done on 'And Now And Then' and would like to see Steve singing the filtered excerpt of Lennon's voice.
I isolated the excerpt from the film 'The Beatles - Now And Then - The Last Beatles Song' and coded the page and was satisfied for the moment.
For publication I didn't use John's voice (of course)... I got free voices on the Internet.

the link:

http://jrlazz.eu5.org/r90/examples/audio_voice.html


Thanks to the Three.js Team!

*/

</script>

</body>
</html>
