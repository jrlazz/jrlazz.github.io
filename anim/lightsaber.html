<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>lightsaber.html</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link rel="icon" type="image/png" href="../img/github-mark.png">
<meta name="description" content="Lightsaber">
<meta name="twitter:image" content="img/ag_baboy_right.png" />
<meta name="twitter:image:type" content="png" />
<meta name="twitter:image:width" content="19" />
<meta name="twitter:image:height" content="47" />

<style>
body {margin:0; overflow:hidden; background:#000; color:#0cf; font-family:monospace;}
span {position:absolute; left:10px; top:10px; font-size:20.5pt;}
</style>

</head>

<body>
<span style="left:10px;top:10px;color:#0cf;">Steve's lightsaber</span>
<span id="clo" style="width:99%;top:45%;text-align:center;color:#ff0;">Please wait a moment...</span>

<script type="importmap">
{
	"imports": {
		"three": "https://cdn.jsdelivr.net/npm/three@0.181.0/build/three.module.js",
		"three/addons/": "https://cdn.jsdelivr.net/npm/three@0.181.0/examples/jsm/"
	}
}
</script>

<script type="module">
import * as THREE from 'three';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
import {EffectComposer} from 'three/addons/postprocessing/EffectComposer.js';
import {RenderPass} from 'three/addons/postprocessing/RenderPass.js';
import {UnrealBloomPass} from 'three/addons/postprocessing/UnrealBloomPass.js';
import {ShaderPass} from 'three/addons/postprocessing/ShaderPass.js';
import {OutputPass} from 'three/addons/postprocessing/OutputPass.js';
import {RoomEnvironment} from 'three/addons/environments/RoomEnvironment.js';
import {Capsule} from 'three/addons/math/Capsule.js';
import {MTLLoader} from 'three/addons/loaders/MTLLoader.js';
import {OBJLoader} from 'three/addons/loaders/OBJLoader.js';

var AdditiveBlendShader={
	uniforms:{baseTexture:{value:null},bloomTexture:{value:null}},
	vertexShader:`varying vec2 vUv;
	void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,
	fragmentShader:`uniform sampler2D baseTexture;
	uniform sampler2D bloomTexture;
	varying vec2 vUv;
	void main(){gl_FragColor=texture2D(baseTexture,vUv)+texture2D(bloomTexture,vUv);}`
};

var renderer, scene, camera, controls, element, color, manager, point, cap;
var B_L, bloomLayer, darkMaterial, renderPass, bloomPass, bloomComposer, finalComposer, blendPass, bloomFolder,toneMappingFolder;
var p=Math.PI;

var mesh=[];
var materials={};
var t=0;
var q1=0.05;
var element=document.getElementById("clo");
var altera=0;
var BDs,BDi,BEs,BEi,PDs,PDi,PEs,PEi,CA,TR,mo,cox;
var rot=[];
var geo=[];
var mat=[];
var g=new THREE.Group();
var groupCATR=new THREE.Group();
var groupPD=new THREE.Group();
var groupPE=new THREE.Group();
var groupBD=new THREE.Group();
var groupBE=new THREE.Group();

	renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
	renderer.setSize(window.innerWidth,window.innerHeight);
	renderer.setPixelRatio(window.devicePixelRatio);
	renderer.toneMapping=THREE.ReinhardToneMapping;
	renderer.setClearColor('#024',0);
	document.body.appendChild(renderer.domElement);

	scene=new THREE.Scene();
	scene.environment=new THREE.PMREMGenerator(renderer).fromScene(new RoomEnvironment(),0.04).texture;
	scene.position.set(-1000,-5,0);

	camera=new THREE.PerspectiveCamera(50,innerWidth/innerHeight,0.1,1000,0.1);
	camera.position.set(0,2,50);
	controls=new OrbitControls(camera,renderer.domElement);
	controls.maxPolarAngle=p/2;

	manager=new THREE.LoadingManager();
	manager.onStart=function(url,itemsLoaded,itemsTotal){console.log('Started loading file:'+url+'.\nLoaded '+itemsLoaded+' of '+itemsTotal + ' files.' );};
	manager.onLoad=function(){console.log('Loading complete!');};
	manager.onProgress=function(url,itemsLoaded,itemsTotal){console.log('loading texture'+url+' '+(itemsLoaded/itemsTotal*100)+'%');};
	manager.onError=function(url){console.log('Error loading texture:'+url);};

	mo="models/steve/partes.mtl";
	cox="models/steve/vivicox.obj";
	new MTLLoader(manager).load(mo,function(mat){mat.preload();new OBJLoader(manager).setMaterials(mat).load('models/steve/steve_ca.obj',function(object){CA=object;},manager.onProgress,manager.onError);});
	new MTLLoader(manager).load(mo,function(mat){mat.preload();new OBJLoader(manager).setMaterials(mat).load('models/steve/steve_to.obj',function(object){TR=object;},manager.onProgress,manager.onError);});
	new MTLLoader(manager).load(mo,function(mat){mat.preload();new OBJLoader(manager).setMaterials(mat).load(cox, function(object){BDs=object;},manager.onProgress,manager.onError);});
	new MTLLoader(manager).load(mo,function(mat){mat.preload();new OBJLoader(manager).setMaterials(mat).load(cox, function(object){BDi=object;},manager.onProgress,manager.onError);});
	new MTLLoader(manager).load(mo,function(mat){mat.preload();new OBJLoader(manager).setMaterials(mat).load(cox, function(object){BEs=object;},manager.onProgress,manager.onError);});
	new MTLLoader(manager).load(mo,function(mat){mat.preload();new OBJLoader(manager).setMaterials(mat).load(cox, function(object){BEi=object;},manager.onProgress,manager.onError);});
	new MTLLoader(manager).load(mo,function(mat){mat.preload();new OBJLoader(manager).setMaterials(mat).load(cox, function(object){PDs=object;},manager.onProgress,manager.onError);});
	new MTLLoader(manager).load(mo,function(mat){mat.preload();new OBJLoader(manager).setMaterials(mat).load(cox, function(object){PDi=object;},manager.onProgress,manager.onError);});
	new MTLLoader(manager).load(mo,function(mat){mat.preload();new OBJLoader(manager).setMaterials(mat).load(cox, function(object){PEs=object;},manager.onProgress,manager.onError);});
	new MTLLoader(manager).load(mo,function(mat){mat.preload();new OBJLoader(manager).setMaterials(mat).load(cox, function(object){PEi=object;},manager.onProgress,manager.onError);});

	scene.add(new THREE.AmbientLight('#fff',5));
	point=new THREE.PointLight('#fff',500);
	point.position.set(20,20,120)
	scene.add(point);

	mesh[0]=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,2,32,1,0,0,p*2),new THREE.MeshStandardMaterial({color:'#036',metalness:0.9,roughness:0.1}));
	mesh[1]=new THREE.Mesh(new THREE.PlaneGeometry(300,3),new THREE.MeshStandardMaterial({color:'#036',metalness:0.9,roughness:0.1}));
        mesh[1].rotation.set(p+p/2,0,0);
        mesh[1].position.set(0,-1,0);
        scene.add(mesh[1]);
        geo[2]=new THREE.CapsuleGeometry(0.2,8,128,32,32);
	geo[2].translate(0,4,0);
        mat[2]=new THREE.MeshStandardMaterial({ color:'#09c'});
        cap=new THREE.Mesh(geo[2],mat[2]);
	cap.add(mesh[0]);
	cap.rotation.set(p/2,0,0);
	cap.position.set(0,-2,0.2);
        scene.add(cap);


	B_L=1;
	bloomLayer=new THREE.Layers();
	bloomLayer.set(B_L);

	cap.layers.enable(B_L);

	darkMaterial=new THREE.MeshBasicMaterial({color:'black'});
	renderPass=new RenderPass(scene,camera);
	bloomPass=new UnrealBloomPass(new THREE.Vector2(innerWidth,innerHeight),1.2,0.4,0.0);
	bloomComposer=new EffectComposer(renderer);
	bloomComposer.renderToScreen=false;
	bloomComposer.addPass(renderPass);
	bloomComposer.addPass(bloomPass);
	finalComposer=new EffectComposer(renderer);
	finalComposer.addPass(renderPass);
	blendPass=new ShaderPass(AdditiveBlendShader,'baseTexture');
	blendPass.uniforms.bloomTexture.value=bloomComposer.renderTarget2.texture;
	finalComposer.addPass(blendPass);
	finalComposer.addPass(new OutputPass());

	bloomPass.strength=0.8;
	bloomPass.radius=0;
	renderer.toneMappingExposure=0.8;

function darkenNonBloomed(obj){	if(obj.isMesh && !bloomLayer.test(obj.layers)){	materials[obj.uuid]=obj.material;obj.material=darkMaterial;}}
function restoreMaterial(obj){if(materials[obj.uuid]){obj.material=materials[obj.uuid];delete materials[obj.uuid];}

}

function animate(){
	requestAnimationFrame(animate);
	scene.traverse(darkenNonBloomed);
	bloomComposer.render();
	scene.traverse(restoreMaterial);

	if(t==50){cap.layers.toggle(B_L);cap.material.opacity=0.0;cap.material.transparent=true;cap.material.needsUpdate=true;}
	if(t==100){cap.layers.toggle(B_L);cap.material.color.set('#09c');cap.material.opacity=1.0;cap.material.transparent=false;cap.material.needsUpdate=true;}
	if(t==100){t=0;}

	// Steve
	if(altera==0){setTimeout(function(){alterando();},1000);}
	if(altera>0){
		t++;
		if(groupPD.rotation.x> 1.07){rot[1]=1;PEi.rotation.x=0;}
		if(groupPD.rotation.x<-1.07){rot[1]=0;PDi.rotation.x=0;}
		if(rot[1]==0){
			g.rotation.z +=q1/10;
			groupPD.rotation.x +=q1;
			groupPE.rotation.x -=q1;
			groupBD.rotation.x -=q1;
			groupBE.rotation.x +=q1;
				CA.rotation.y -=q1/40;
				TR.rotation.x +=q1/10;
					BDi.rotation.x -=q1/40;
					BEi.rotation.x +=q1/40;
					PDi.rotation.x +=q1/10;
					PEi.rotation.x -=q1/10;
		}else{
			g.rotation.z -=q1/10;
			groupPD.rotation.x -=q1;
			groupPE.rotation.x +=q1;
			groupBD.rotation.x +=q1;
			groupBE.rotation.x -=q1;
				CA.rotation.y +=q1/40;
				TR.rotation.x -=q1/10;
					BDi.rotation.x +=q1/40;
					BEi.rotation.x -=q1/40;
					PDi.rotation.x -=q1/10;
					PEi.rotation.x +=q1/10;
		}
		g.position.x +=0.05;
		if(g.position.x>150){g.position.x=-150;}
		if(g.position.x>0 && g.position.x<6){
			g.rotation.y -=p/15;
			if(g.position.x>0 && g.position.x<3){g.position.y +=0.1;}
			if(g.position.x>3){g.position.y -=0.1;}
		}
		if(g.position.x>15){g.position.x +=1;q1=1;}
		if(g.position.x<-35){g.position.x +=1;}
		if(g.position.x>34){q1=0.05;}
	}

	function alterando(){
		CA.position.set(     0, 2.1,0);
		TR.position.set(     0,   2,0);
		BDs.position.set(-1.75,   1,0);
		BDi.position.set(-1.75,-0.5,0);
		BEs.position.set( 1.75,   1,0);
		BEi.position.set( 1.75,-0.5,0);
		PDs.position.set(0.025,   0,0);
		PDi.position.set(0.125,-1.5,0);
		PEs.position.set( 0.56,   0,0);
		PEi.position.set( 0.56,-1.5,0);
		BDs.scale.y=0.5;
		BEs.scale.y=0.5;
		BDi.scale.set(1,0.75,1);BDi.add(cap);
		BEi.scale.set(1,0.75,1);
		PDs.scale.y=0.5;
		PEs.scale.y=0.5;
		PDi.scale.set(0.8,0.8,0.8);
		PEi.scale.set(0.8,0.8,0.8);
		groupCATR.add(CA);groupCATR.add(TR);
		groupPD.add(PDs);groupPD.add(PDi);
		groupPE.add(PEs);groupPE.add(PEi);
		groupBD.add(BDs);groupBD.add(BDi);
		groupBE.add(BEs);groupBE.add(BEi);
		g.add(groupCATR);
		g.add(groupPD);
		g.add(groupPE);
		g.add(groupBD);
		g.add(groupBE);
		g.scale.set(1,1,1);
		groupCATR.position.set( 0,4,0);
		groupPD.position.set(-0.6,3,0);
		groupPE.position.set( 0.0,3,0);
		groupBD.position.set( 0.0,5,0);
		groupBE.position.set( 0.0,5,0);
		g.rotation.y=p/2;
		g.position.set(-100,0,0);
		scene.add(g);
		scene.position.set(0,-5,0);
		if(element){element.remove();}
		altera++;
	}
	finalComposer.render();
}

animate();

window.addEventListener('resize',()=>{
	camera.aspect=innerWidth/innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(innerWidth,innerHeight);
	bloomComposer.setSize(innerWidth,innerHeight);
	finalComposer.setSize(innerWidth,innerHeight);
});

</script>
</body>
</html>

