<!DOCTYPE html>
<html lang="en">
<head>
<title>csg_ok_2.html</title>
<meta charset="utf-8">
<link rel="shortcut icon" href="https://threejs.org/files/favicon.ico"/>

<style>
body{background-color:#069;color:#fc0;margin:0px;overflow:hidden;}
a{color:#0ff;text-decoration:none;}
input,button{font-family:Lucida Console;font-size:14pt;font-weight:bold;border:4px outset #fc0;}
</style>

<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

<script type="importmap">
	{
		"imports":{
			"three":"https://unpkg.com/three@0.155.0/build/three.module.js",
			"three/addons/":"https://unpkg.com/three@0.155.0/examples/jsm/",
			"three-mesh-bvh": "../js/three-mesh-bvh.js",
			"three-bvh-csg": "../js/three-bvh-csg.js"
		}
	}
</script>


</head>

<body>


<input id="valsim" type="text" autocomplete="off" style="position:absolute;left:-100px;top:20px;width:30px;text-align:center;" value=0></input>
<button style="position:absolute;left:20px;top:20px;width:130px;" onclick="javascript:document.getElementById('valsim').value='1';">export</button>
<div style="position:absolute;left:40%;top:20px;font-family:Lucida Console;font-size:14pt;">bvh csg - <a href="https://github.com/gkjohnson/three-bvh-csg" target="_blank" rel="noopener">three-bvh-csg</a></div>

<script type="module">

import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GUI } from 'three/addons/libs/lil-gui.module.min.js';
import { SUBTRACTION, DIFFERENCE, INTERSECTION, ADDITION, Brush, Evaluator } from '../js/three-bvh-csg.js';
import { STLExporter } from 'three/addons/exporters/STLExporter.js';

var controls,gui,camera,scene,renderer,baseBrush,brush,core,result,evaluator,wireframe,lightA,lightP,exporter,link;
var w=0;
var csgsim=0;
//var materialNormal;

const params={operation:SUBTRACTION,useGroups:true,wireframe:false,};

function init() {

	camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,1,1000);
	camera.position.set(0,10,5);

	scene=new THREE.Scene();
	scene.background=new THREE.Color('#069');

	renderer=new THREE.WebGLRenderer({antialias:true});
	renderer.setPixelRatio(window.devicePixelRatio);
	renderer.setSize(window.innerWidth,window.innerHeight);
	document.body.appendChild(renderer.domElement);

	lightA=new THREE.AmbientLight('#fff',1);scene.add(lightA);

	lightP=new THREE.PointLight('#fff',4000);lightP.position.set(20,20,0);scene.add(lightP);


	brush=new Brush(new THREE.SphereGeometry(2,128,128),new THREE.MeshStandardMaterial({color:'#060'}),);

// IMPORTANTE ... before and after

	brush.updateMatrixWorld();
		brush.position.set(1.5,0,0);
	brush.updateMatrixWorld();



// IMPORTANTE
// capped ... false

	baseBrush=new Brush(new THREE.CylinderGeometry(1,1,5,64,64,false),new THREE.MeshStandardMaterial({color:'#c90',side:THREE.DoubleSide}),);

	baseBrush.updateMatrixWorld();
		baseBrush.rotation.set(1,1,0);
	baseBrush.updateMatrixWorld();

	wireframe=new THREE.Mesh(undefined,new THREE.MeshBasicMaterial({color:'#ff0',wireframe:true}),);
	scene.add(wireframe);

	controls=new OrbitControls(camera,renderer.domElement);

	gui=new GUI();
	gui.add(params,'operation',{SUBTRACTION,DIFFERENCE,INTERSECTION,ADDITION});
	gui.add(params,'wireframe');
	gui.add(params,'useGroups');

	window.addEventListener('resize',onWindowResize);
	onWindowResize();

	evaluator=new Evaluator();
	exporter=new STLExporter();



}

function updateCSG() {
	evaluator.useGroups=params.useGroups;
	result=evaluator.evaluate(baseBrush,brush,params.operation,result);
	scene.add(result);
	if(document.getElementById("valsim").value=="1"){exportBinary();csgsim=1;document.getElementById("valsim").value="0";}
}

function onWindowResize(){
	camera.aspect=window.innerWidth/window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(window.innerWidth,window.innerHeight);
}

function animate(){
	requestAnimationFrame(animate);
	w++;
	if(w==100){updateCSG();wireframe.geometry=result.geometry;wireframe.visible=params.wireframe;w=0;}
	controls.update();
	renderer.render( scene, camera );
}


link=document.createElement('a');
link.style.display='none';
document.body.appendChild(link);

function save(blob,filename){
	link.href=URL.createObjectURL(blob);
	link.download=filename;
	link.click();
}

function exportBinary(){const resultado=exporter.parse(result,{binary:true});saveArrayBuffer(resultado,'csg.stl');}

function saveArrayBuffer(buffer,filename){save(new Blob([buffer],{type:'application/octet-stream'}),filename);}


init();
animate();



/*

Hi,
I do not use npm…
I saved three-mesh-bvh.js from https://unpkg.com/three-mesh-bvh@0.6.0/build/index.module.js,
and three-bvh-csg.js from https://unpkg.com/three-bvh-csg@0.0.7/build/index.module.js,
and used the files in a local js path… that is the link…

http://jrlazz.eu5.org/anim/csg_ok_2.html

*/

</script>



</body>
</html>
