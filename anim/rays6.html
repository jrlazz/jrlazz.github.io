<!DOCTYPE html>
<html lang="en">
<head>
<title>rays6.html</title>
<meta charset="utf-8">
<link rel="shortcut icon" href="ok.ico"/>
<style>
body{margin:0;background-color:#000;font-family:Monospace;font-size:12pt;color:#cff;overflow:hidden;}
</style>
<script type="importmap">
	{
	  "imports": {
		"three": "https://unpkg.com/three@0.171.0/build/three.module.min.js",
		"three/addons/": "https://unpkg.com/three@0.171.0/examples/jsm/"
	  }
	}
  </script>
</head>

<body>

<span id="nome" style="position:absolute;left:45%;top:10px;font-size:21pt;color:#ff0;opacity:0.5;display:none;"></span>

<audio id="audio" loop><source id="sour" src="mp3/watchtower.mp3" type="audio/mpeg"></audio>

<button id="BA" onclick="javascript:location.href='rays6.html';" style="position:absolute;left:80%;top:28px;width:200px;background-color:#900;color:#fff;display:;">Restart</button>
<a href="rays6.txt" target="_blank" class="bu" style="position:absolute;left:80%;top:68px;width:200px;background-color:#060;color:#fff;text-align:center;text-decoration:none;border:2px outset #ff0;">View code</a>

<code id="mus">
<img src="img\music.png" style="position:absolute;left:10px;top:10px;width:40px;height:40px;cursor:pointer;"></img>
<span id="click" style="position:absolute;left:60px;top:20px;cursor:pointer;">click to play</span>
<input id="gai" type="range" value="1" min="0" max="5" step="0.1" autocomplete="off" style="position:absolute;left:60px;top:20px;width:120px;display:none;""></input>
<span id="spanB" style="position:absolute;left:190px;top:20px;display:none;"">1</span>
</code>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { SVGLoader } from 'three/addons/loaders/SVGLoader.js';

var scene, camera, renderer, controls, loader, ambLight, Beam, objectArray=[], PP, BM, WT;
var sea, texsea, whale, texwhale, yelsub, texyelsub, moon, texmoon, texbeam;
var iW=window.innerWidth, iH=window.innerHeight, mouse={x:0,y:0};
var raycaster=new THREE.Raycaster();
var intersectArray, normalMatrix, normalVector;

var h=10,t=2,tt=100,ttt=0,passo=0.0002;
var sim=0;
var inisim=0;
var axe;
var ge=[];
var ma=[];
var sh=[];
var nom=[];
nom[4]="The";
nom[3]="Guitar";
nom[2]="Man";
nom[1]="Jimmi";
nom[0]="Hendrix";
var paths=[],shapes=[],dep=1,cur=5;

var groupA=new THREE.Group();
var groupB=new THREE.Group();
var groupC=new THREE.Group();
var gro=[];for(let z=1;z<300;z++){gro[z]=new THREE.Group();}

var aCtx=null, source, gainMP3;

var bId=function(id){return document.getElementById(id);}
var dnome=bId("nome");
var mp3val=bId("mp3");
var mgain=bId("gai");
var dspanB=bId("spanB");
var dmus=bId("mus");
var dclick=bId("click");
var dgai=bId("gai");
	mgain.onchange=function FGAI(){mp3gain();}

	scene=new THREE.Scene();

	camera=new THREE.PerspectiveCamera(60,iW/iH,1,1000);
	camera.position.set(0,10,50);
	scene.add(camera);

	renderer=new THREE.WebGLRenderer({ antialias: true, alpha: true });
	renderer.setSize(iW, iH);
	renderer.setClearColor(0x222222,0);
	document.body.appendChild(renderer.domElement);
	window.addEventListener('resize',onWindowResize);

	controls=new OrbitControls(camera,renderer.domElement);
	controls.enablePan=false;
	controls.minDistance=10;
	controls.maxDistance=55;
	controls.minPolarAngle=0.57;
	controls.maxPolarAngle=1.57;

	ambLight=new THREE.AmbientLight('#fff',2);
	scene.add(ambLight);

	texsea=new THREE.TextureLoader().load('img/seapexels.jpg');
	texsea.wrapS=THREE.RepeatWrapping;texsea.wrapT=THREE.RepeatWrapping;
	texsea.repeat.set(2,2);
	ge[30]=new THREE.CircleGeometry(50,32);
	ma[30]=new THREE.MeshStandardMaterial({color:'#355',map:texsea,side:THREE.DoubleSide});
	sea=new THREE.Mesh(ge[30],ma[30]);
	sea.position.set(0,-2,0);
	sea.rotation.x=-Math.PI/2;
	scene.add(sea);

	texwhale=new THREE.TextureLoader().load('img/whale.png');
	ge[31]=new THREE.PlaneGeometry(20,20);
	ma[31]=new THREE.MeshStandardMaterial({color:'#fff',map:texwhale,transparent:true,side:THREE.DoubleSide});
	whale=new THREE.Mesh(ge[31],ma[31]);
	whale.position.set(0,0,0);
	whale.name="Whale";objectArray.push(whale);

	texyelsub=new THREE.TextureLoader().load('img/yelsub.png');
	ge[32]=new THREE.PlaneGeometry(5,10);
	ma[32]=new THREE.MeshStandardMaterial({color:'#fff',map:texyelsub,transparent:true,side:THREE.DoubleSide});
	yelsub=new THREE.Mesh(ge[32],ma[32]);
	yelsub.position.set(-20,-4,30);
	yelsub.name="Yellow Submarine";objectArray.push(yelsub);

	axe=new THREE.AxesHelper(0.01);
	axe.add(whale);
	axe.position.set(-35,1,-5);
	axe.rotation.z=3;
	scene.add(axe);
	
	for (let i=0;i<5;i++){
		h--;
		ge[i]=new THREE.BoxGeometry(0.5,h,2);
		ge[i].translate(0,h/2,2);
		ma[i]=new THREE.MeshPhongMaterial({color:new THREE.Color('hsl('+i*40+',100%,50%)')});
		sh[i]=new THREE.Mesh(ge[i],ma[i]);
		sh[i].position.set(0,-1,-1+i*-3);
		sh[i].name="Tower "+nom[i];objectArray.push(sh[i]);
	}

	ge[9]=new THREE.BoxGeometry(0.2,0.2,0.2);
	ma[9]=new THREE.MeshPhongMaterial({color:'#030',transparent:false,opacity:0.5});
	sh[9]=new THREE.Mesh(ge[9],ma[9]);
	for(let i=0;i<5;i++){sh[9].add(sh[i]);}
	sh[9].position.set(-10,0.5,-40);
	sh[9].rotation.y=1.5;
	sh[9].name="City";objectArray.push(sh[9]);

	ge[10]=new THREE.SphereGeometry(0.22, 16, 16);
	ma[10]=new THREE.MeshStandardMaterial({color:'#00c'});
	sh[10]=new THREE.Mesh(ge[10],ma[10]);
	sh[10].position.set(0, 2, 0);

	texmoon=new THREE.TextureLoader().load('img/moonR.jpg');
	ge[11]=new THREE.SphereGeometry(4,32,32);
	ma[11]=new THREE.MeshStandardMaterial({color:'#fff',map:texmoon});
	moon=new THREE.Mesh(ge[11],ma[11]);
	moon.position.set(-55,3,10);
	moon.name="Moon";objectArray.push(moon);

	ge[12]=new THREE.SphereGeometry(1,32,32);
	ma[12]=new THREE.MeshStandardMaterial({color:'#fc9'});
	PP=new THREE.Mesh(ge[12],ma[12]);
	PP.position.set(50,2,10);
	PP.name="Asteroid B-612";objectArray.push(PP);

	ge[13]=new THREE.SphereGeometry(1,32,32);
	ma[13]=new THREE.MeshStandardMaterial({color:'#000'});
	BM=new THREE.Mesh(ge[13],ma[13]);
	BM.position.set(36,2,-12);
	BM.name="Blue Mountain";objectArray.push(BM);

	ge[14]=new THREE.CylinderGeometry(0.15,0.15,1.1);
	ma[14]=new THREE.MeshStandardMaterial({color:'#f00'});
	WT=new THREE.Mesh(ge[14],ma[14]);
	WT.position.set(0,1.63,0);
	
	ma[20]=[new THREE.MeshStandardMaterial({color:'#c90'}),new THREE.MeshStandardMaterial({color:'#630'})];// front & side
	ma[21]=new THREE.MeshStandardMaterial({color:'#fff'});
	ma[22]=[new THREE.MeshStandardMaterial({color:'#090'}),new THREE.MeshStandardMaterial({color:'#069'})];// front & side

	loader=new SVGLoader();
	loader.load('img/terreno.svg',function(data){
		paths=data.paths;
		shapes=SVGLoader.createShapes(paths[0]);
		ge[20]=new THREE.ExtrudeGeometry(shapes[0],{depth:dep,curveSegments:cur});
		for(let i=20;i<23;i++){
			sh[i]=new THREE.Mesh(ge[20],ma[i]);
			sh[i].position.set(0,-2,0);
			sh[i].rotation.set(Math.PI/2,0,0);
			sh[i].scale.setScalar(0.1);
		}
	})

	texbeam=new THREE.TextureLoader().load('img/semi2.png');
	ge[40]=new THREE.PlaneGeometry(1,0.1*3);
	ge[40].rotateY(0.5*Math.PI);
	ma[40]=new THREE.MeshBasicMaterial({map:texbeam,color:'#0ff',side:THREE.DoubleSide,transparent:true,opacity:0.9});

	Beam=new Laser();
	add2Scene(Beam);

function add2Scene(obj){
	scene.add(obj.object3d);
	scene.add(obj.pointLight);
}

function Laser(){
	this.object3d=new THREE.Object3D();
	this.pointLight=new THREE.PointLight('#66f',8,0,0.7);

	const nPlanes=5;
	for (let i=0;i<nPlanes;i++){
		sh[40]=new THREE.Mesh(ge[40],ma[40]);
		sh[40].position.z=1/2;
		sh[40].rotation.z=i/nPlanes*Math.PI;
		this.object3d.add(sh[40]);
	}

	this.intersect=(direction, objectArray=[]) => {
		raycaster.set(this.object3d.position.clone(), direction.clone().normalize());
		intersectArray=raycaster.intersectObjects(objectArray, true);
		if (intersectArray.length>0){
			if(ttt>20){dnome.innerText=intersectArray[0].object.name;}
			this.object3d.scale.z=intersectArray[0].distance;
			this.object3d.lookAt(intersectArray[0].point.clone());
			this.pointLight.visible=true;
			normalMatrix=new THREE.Matrix3().getNormalMatrix(intersectArray[0].object.matrixWorld);
			normalVector=intersectArray[0].face.normal.clone().applyMatrix3(normalMatrix).normalize();
			this.pointLight.position.copy(intersectArray[0].point.clone().add(normalVector.clone().multiplyScalar(0.5)));

		} else {
			this.pointLight.visible=false;
			this.object3d.lookAt(this.object3d.position.clone().add(direction));
		}
	}
}

function init(){
	if(inisim==0){inisim=1;setupAudio();console.clear();dclick.style.display="none";dgai.style.display="";dspanB.style.display="";}
}

function setupAudio(){
	window.AudioContext=window.AudioContext || window.webkitAudioContext;
	aCtx=new AudioContext();
	gainMP3=aCtx.createGain();
	gainMP3.connect(aCtx.destination);
	source=aCtx.createMediaElementSource(audio);
	source.connect(gainMP3);
	audio.load();
	audio.play();
	gainMP3.gain.value-1;
}

function mp3gain(){dspanB.innerText=mgain.value;if(gainMP3){gainMP3.gain.value=mgain.value;}}

function onWindowResize(){
	iW=window.innerWidth;iH=window.innerHeight;
	camera.aspect=iW/iH;
	camera.updateProjectionMatrix();
	renderer.setSize(iW,iH);
	}

function animate(){
	requestAnimationFrame(animate);

if(sim==1 && axe){
	tt++;
	if(tt<200){sea.rotation.z +=passo;}
	if(tt>=200){sea.rotation.z -=passo;}
	if(tt>400){tt=0;}
	axe.rotation.z -=0.02;

	ttt++;
	if(ttt<600){yelsub.position.y +=passo*36;yelsub.position.x +=passo*160;}
	if(ttt>=600 && ttt<700){yelsub.position.x +=passo*160;}
	if(ttt>=700){yelsub.position.y -=passo*36;yelsub.position.x +=passo*160;}
	if(ttt>1400){ttt=0;yelsub.position.x=-20;yelsub.position.y=-4;}
}

if(Beam){
	dnome.style.display="";
	t=t+0.02;if(t>6.28){t=0;}
	Beam.object3d.position.set(0,2,0);
	Beam.object3d.rotation.y +=0.01;
	Beam.intersect(new THREE.Vector3(Math.cos(t),0,Math.sin(t)), objectArray);
}

	if(sh[20] && sh[21] && sh[22] && sea && moon && PP && BM && sh[10] && WT && yelsub && sim==0){
		groupA.add(sh[20]);
		groupB.add(sh[21]);
		groupC.add(sh[22]);
		let k=0;
		for(let z=0;z<15;z++){
			k=k+0.1;
			gro[z]=groupA.clone();
			gro[z].scale.set(k,1+k/2,k);
			gro[z].position.set(0,3.3-k,0);
			scene.add(gro[z]);
		}

		gro[9]=groupA.clone();gro[9].scale.set(3,8,3);
		gro[9].position.set(-17,15,-40);scene.add(gro[9]);
		scene.add(sh[9]);

		k=0.5;
		for(let z=5;z<30;z++){
			k=k+0.1;
			gro[z]=groupB.clone();
			if(z>15){gro[z]=groupC.clone();}
			gro[z].scale.set(k/1.5,1+k*1.7,k/1.5);
			gro[z].position.set(36,11,-12);
			scene.add(gro[z]);
		}
		scene.add(moon);
		scene.add(PP);
		scene.add(BM);
		scene.add(sh[10]);
		scene.add(WT);
		scene.add(yelsub);
		sim=1;
	}
	controls.update();
	renderer.render(scene, camera);
}

document.addEventListener('click',event => {init();},false);

animate();

</script>
</body>
</html>