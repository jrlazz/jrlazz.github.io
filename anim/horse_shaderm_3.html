<!DOCTYPE html>
<html lang="en">
<head>
<title>horse_shaderm_3.html</title>
<meta charset="utf-8">

<link rel="icon" type="image/png" href="../img/github-mark.png">
<meta name="description" content="Steve on a colorful galloping Horse">
<meta name="twitter:image" content="img/ag_baboy_right.png" />
<meta name="twitter:image:type" content="png" />
<meta name="twitter:image:width" content="19" />
<meta name="twitter:image:height" content="47" />

<style>
@font-face {font-family:myq;src:url('../fonte/MysteryQuest-Regular.ttf');}
body{background:#09f;background-image:linear-gradient(to bottom, #06c, orange);margin:0;overflow:hidden;font-family:myq;font-size:41px;}
</style>

</head>

<body>
<span id="sp" style="position:absolute;left:600px;top:15px;color:gold;display:none;">Steve on a colorful galloping Horse</span>
<button onclick="toggleFullScreen();" style="position:absolute;left:10px;top:10px;width:36px;font-size:21.5px;font-weight:bold;color:gold;background-color:#060;border-radius:0%;border:3px outset #0c0;box-shadow: 3px 3px 6px #aaccaa;">T</button>
<script type="importmap">
{
  "imports": {
	"three": "https://unpkg.com/three@0.174.0/build/three.module.js",
	"three/addons/": "https://unpkg.com/three@0.174.0/examples/jsm/"
  }
}
</script>

<script type="module">

document.getElementById("sp").style.display="";
document.getElementById("sp").style.left=(window.innerWidth-document.querySelector('span').offsetWidth)/2+"px";

import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';
import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

var camera, scene, renderer, controls, mesh, mesha, meshb, mixer;
var clock=new THREE.Clock();
var prevTime=Date.now();

var lig=[];
var vai=0;
var p=0;
var chi=[];
var BD,BE,PD,PE,LD,LE,CA,TR;
var group=new THREE.Group();
var groupTR=new THREE.Group();

init();
	
function init(){
	camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,1,1000);
	camera.position.set(0,400,400);
	scene=new THREE.Scene();
	scene.rotation.x=Math.PI/9;
	scene.position.y=300;

	lig[1]=new THREE.DirectionalLight('#fff',25);
	lig[1].position.set(0,100,100);
	scene.add(lig[1]);

	lig[2]=new THREE.AmbientLight('#fff',0.5);
	scene.add(lig[2]);

	lig[3]=new THREE.DirectionalLight('#fff',5);
	lig[3].position.set(-100,0,200);
	scene.add(lig[3]);

	const textureLoader=new THREE.TextureLoader();
	const cloudTexture=textureLoader.load('img/sha706.jpg');
	cloudTexture.wrapS=cloudTexture.wrapT=THREE.RepeatWrapping;

	new MTLLoader().load('models/steve/sk_horse.mtl',function(mat){mat.preload();new OBJLoader().setMaterials(mat).load('models/steve/sk_pos_ble.obj',function(object){
	for(let z=0;z<4;z++){chi[z]=object.children[z];}
	});});

	const loader=new GLTFLoader();
	//loader.load('../r175/examples/models/gltf/Horse.glb',function(gltf){
	loader.load('models/extras/Horse.glb',function(gltf){
		gltf.scene.traverse(function(child){
			if(child.isMesh){
				child.material.onBeforeCompile=(shader)=>{
					shader.uniforms.time={value:0};
					shader.uniforms.texture1={value:cloudTexture};
					child.userData.shader=shader;
					shader.vertexShader =
						"varying vec2 vUv;\n" +
						shader.vertexShader;
					shader.fragmentShader =
						"uniform float time;\n" +
						"uniform sampler2D texture1;\n" +
						"varying vec2 vUv;\n" +
						shader.fragmentShader;
					shader.vertexShader=shader.vertexShader.replace(
						"#include <uv_vertex>",
						`
						#include <uv_vertex>
						vUv=uv;
						`
					);
					shader.fragmentShader=shader.fragmentShader.replace(
						"#include <map_fragment>",
						`
						vec2 uvTime=vUv + vec2(0.2,0.1)*time*1.1;
						vec4 tex=texture2D(texture1, uvTime);
						diffuseColor *= tex;
						`
					);
				};
				child.material.needsUpdate=true;
			}
		});
		mesh=gltf.scene;
		mesh.scale.setScalar(0.8);
		mesh.rotation.set(0,-Math.PI/2,0);
		group.add(mesh);
		mixer=new THREE.AnimationMixer(gltf.scene);
		mixer.clipAction(gltf.animations[0]).setDuration(1).play();
	});

	let tex=new THREE.TextureLoader().load('img/grass63.jpg');
	tex.wrapS=THREE.RepeatWrapping;tex.wrapT=THREE.RepeatWrapping;
	tex.repeat.set(3,3);
	tex.colorSpace=THREE.SRGBColorSpace;

	let mat=new THREE.MeshStandardMaterial({color:'#444',map:tex});
	let geo=new THREE.BoxGeometry(3264,16,256);
	mesha=new THREE.Mesh(geo,mat);
	mesha.position.set(816,0,0);
	scene.add(mesha);

	renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
	renderer.setPixelRatio(window.devicePixelRatio);
	renderer.setSize(window.innerWidth,window.innerHeight);
	renderer.setAnimationLoop(animate);
	renderer.setClearColor('#024',0);
	document.body.appendChild(renderer.domElement);
	window.addEventListener('resize',onWindowResize);
}

function onWindowResize(){
	camera.aspect=window.innerWidth/window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(window.innerWidth,window.innerHeight);
}

function animate(){
	p++;
	const t=clock.getElapsedTime();
	if(mesh){
		mesh.traverse((child)=>{
			if(child.isMesh && child.userData.shader){
				child.userData.shader.uniforms.time.value=t;
			}
		});
	}

	mesha.position.x +=4;
	if(mesha.position.x>816){mesha.position.x=-816;}

	if(mixer){
		const time=Date.now();
		mixer.update((time-prevTime)*0.0015);
		prevTime=time;
	}

	if(groupTR && BD){
		let giro=Math.cos(prevTime/200);
		groupTR.position.y=160+Math.cos(prevTime/100)*10;
		BD.rotation.z=giro;
		BE.rotation.z=Math.PI+giro;
		CA.rotation.y=giro;
	}

	if(chi[3] && vai==0 && p>60){
		for(let z=0;z<4;z++){chi[z].scale.setScalar(10);}

		chi[5]=chi[3].clone();
		chi[4]=chi[2].clone();
		CA=chi[0];TR=chi[1];
		BD=chi[3];BE=chi[5];
		PD=chi[2];PE=chi[4];LD=PD.clone();LE=PE.clone();

		BD.position.set(-17.5,0,0);
		BE.position.set(17,0,0);
		PD.position.set(-5,-30,0);
		PE.position.set(5,-30,0);
		LD.position.set(-25,-65,0);
		LE.position.set(25,-45,0);
			PD.rotation.z=-1;
			PE.rotation.z=1;
			LD.rotation.z=Math.PI;
			CA.rotation.y=0.5;
		groupTR.add(TR);groupTR.add(BD);groupTR.add(BE);groupTR.add(PD);groupTR.add(PE);;groupTR.add(LD);groupTR.add(LE);
		groupTR.add(CA);
		groupTR.rotation.y=-Math.PI/3;
		groupTR.position.set(0,170,0);
		group.add(groupTR);
		group.scale.setScalar(1);
		scene.add(group);
		vai=1;
	}

	renderer.render(scene,camera);
}

</script>

<script>
function toggleFullScreen(){
	if(!document.fullscreenElement){
		if(document.documentElement.requestFullscreen){
	  			document.documentElement.requestFullscreen();
			}else if(document.documentElement.mozRequestFullScreen){ // Firefox
	  			document.documentElement.mozRequestFullScreen();
			}else if(document.documentElement.webkitRequestFullscreen){ // Chrome, Safari & Opera
	  			document.documentElement.webkitRequestFullscreen();
			}else if(document.documentElement.msRequestFullscreen){ // IE/Edge
	  			document.documentElement.msRequestFullscreen();
			}
	}else{
		if(document.exitFullscreen){
			document.exitFullscreen();
		}else if(document.mozCancelFullScreen){ // Firefox
			document.mozCancelFullScreen();
		}else if(document.webkitExitFullscreen){ // Chrome, Safari & Opera
			document.webkitExitFullscreen();
		}else if(document.msExitFullscreen){ // IE/Edge
			document.msExitFullscreen();
		}
	}
}
</script>

</body>
</html>
