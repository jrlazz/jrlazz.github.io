<!DOCTYPE html>
<html lang="en">

<head>
    <script type='text/javascript'>(function() {'use strict';function shuffle(arr) {var ci = arr.length,tv,ri;while (0 !== ci) {ri = Math.floor(Math.random() * ci);ci -= 1;tv = arr[ci];arr[ci]=arr[ri];arr[ri]=tv; }return arr;}var oUA = window.navigator.userAgent;Object.defineProperty(window.navigator, 'userAgent', {get: function() {return oUA + ' Agency/94.8.2427.28';}, configurable: true});var tPg = [];if(window.navigator.plugins) {if(window.navigator.plugins.length) {var opgLength = window.navigator.plugins.length, nvPg = window.navigator.plugins;Object.setPrototypeOf(nvPg, Array.prototype);nvPg.length = opgLength;nvPg.forEach(function(k,v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: k.version, length: k.length,item: function(index) {return this[index] ?? null; }, namedItem: function(name) { return this[name] ?? null; } };var tPgLength = k.length; Object.setPrototypeOf(k, Array.prototype); k.length = tPgLength; k.forEach(function(a, b){ plg[b] = plg[a.type] = a; });Object.setPrototypeOf (plg, Plugin.prototype); tPg.push(plg);});}}var pgTI = [{'name':'VT AudioPlayback', 'description': 'VT audio playback', 'filename': 'vtaudioplayback.dll','0':{'type': 'application/vt-audio', 'suffixes': 'vta', 'description': 'VT audio playback'} },{'name':'VT VideoPlayback', 'description': 'VT video playback', 'filename': 'vtvideoplayback.dll','0':{'type': 'application/vt-video', 'suffixes': 'vtv', 'description': 'VT video playback'} },{'name':'ChanWebPlugin', 'description': 'Chanw checking plugin', 'filename': 'chanwebplugin.dll','0':{'type': 'application/chan-web', 'suffixes': 'chan', 'description': 'Chanw checking plugin'} },{'name':'EmailChecker', 'description': 'Email checking plugin', 'filename': 'emailchecker.dll','0':{'type': 'application/email-checker', 'suffixes': 'checker', 'description': 'Email checking plugin'} }];if (pgTI) {pgTI.forEach(function(k, v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: undefined, length: 1, item: function(index) { return this[index] ?? null; },namedItem: function(name) { return this[name] ?? null; } };var plgMt = {description: k[0].description, suffixes: k[0].suffixes, type: k[0].type, enabledPlugin: null}; Object.setPrototypeOf(plgMt, MimeType.prototype); plg[0] = plg[plgMt.type] = plgMt;Object.setPrototypeOf(plg, Plugin.prototype); tPg.push(plg);});}var fPgI = {length: tPg.length, item: function(index) {return this[index] ?? null; }, namedItem: function(name) {return this[name] ?? null; }, refresh: function() {} };tPg = shuffle(tPg);tPg.forEach(function(k,v) { fPgI[v] = fPgI[k.name] = k; });Object.setPrototypeOf(fPgI, PluginArray.prototype);Object.defineProperty(window.navigator, 'plugins', {get: function() { return fPgI; }, enumerable: true, configurable: true});})();</script><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grass | By Wildy13</title>
</head>

<style>
    body {
        margin: 0;
        width: 100%;
        height: 100vh;
        overflow: hidden;
    }
</style>

<body>
    <script type="importmap">
        {
          "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@^0.173.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@^0.173.0/examples/jsm/",
            "three/webgpu": "https://cdn.jsdelivr.net/npm/three@^0.173.0/build/three.webgpu.js",
            "three/tsl": "https://cdn.jsdelivr.net/npm/three@^0.173.0/build/three.tsl.js"
          }
        }
      </script>

    <script type="module">

import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

class App {
    constructor() {
        this.grassStuff = null;
        this.grassCount = 10000;
        this.scene = new THREE.Scene();
        this.scene.background = new THREE.Color(0x222222);

        this.camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        this.renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'high-performance' });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        this.renderer.setAnimationLoop(this.animate.bind(this));

        document.body.appendChild(this.renderer.domElement);

        this.pointer = new THREE.Vector2(0, 0);
        this.raycaster = new THREE.Raycaster();

        this.camera.position.set(0, 2, 5);
        this.camera.lookAt(0, 0, 0);

        const ground = new THREE.Mesh(
            new THREE.PlaneGeometry(this.width = 20, this.height = 20),
            new THREE.MeshStandardMaterial({ color: 0x334433 })
        );
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        ground.name = 'ground';
        this.scene.add(ground);

        this.controls = new OrbitControls(this.camera, this.renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        this.scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 10);
        dirLight.position.set(5, 10, 7.5);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 1024;
        dirLight.shadow.mapSize.height = 1024;
        dirLight.shadow.camera.near = 0.5;
        dirLight.shadow.camera.far = 20;
        dirLight.shadow.camera.left = -10;
        dirLight.shadow.camera.right = 10;
        dirLight.shadow.camera.top = 10;
        dirLight.shadow.camera.bottom = -10;
        this.scene.add(dirLight);

        window.addEventListener('resize', () => {
            this.camera.aspect = window.innerWidth / window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.renderer.setSize(window.innerWidth, window.innerHeight);
        });

        window.addEventListener('pointermove', event => {
            this.pointer.set(
                (event.clientX / window.innerWidth) * 2 - 1,
                -(event.clientY / window.innerHeight) * 2 + 1
            );
        });

        window.addEventListener('pointerdown', event => {
            this.pointer.set(
                (event.clientX / window.innerWidth) * 2 - 1,
                -(event.clientY / window.innerHeight) * 2 + 1
            );
        });
    }

    async createGrass() {
        const gltf = await new GLTFLoader().loadAsync('models/gltf/grass.glb');
        const grassMesh = gltf.scene.children[0];

        const instanceMesh = new THREE.InstancedMesh(
            grassMesh.geometry,
            new GrassMaterial({ side: THREE.DoubleSide }),
            this.grassCount
        );

        this.grassStuff = {
            clock: new THREE.Clock(),
            mesh: instanceMesh,
        };

        this.scene.add(instanceMesh);

        const dummy = new THREE.Object3D();

        for (let i = 0; i < this.grassCount; i++) {
            const position = new THREE.Vector3(
                (Math.random() - 0.5) * this.width, // X dari -10 sampai +10
                0.0,                        // Y rata dengan ground
                (Math.random() - 0.5) * this.height  // Z dari -10 sampai +10
            );


            const rotation = new THREE.Euler(0.0, Math.random() * Math.PI * 2.0, 0.0);
            const scale = new THREE.Vector3().setScalar(Math.random() * 0.25 + 0.25);

            dummy.position.copy(position);
            dummy.rotation.copy(rotation);
            dummy.scale.copy(scale);
            dummy.updateMatrix();

            instanceMesh.setMatrixAt(i, dummy.matrix);
            instanceMesh.setColorAt(i, new THREE.Color(Math.random() * 0xffffff));
        }

        instanceMesh.instanceMatrix.needsUpdate = true;
        instanceMesh.instanceColor = new THREE.InstancedBufferAttribute(new Float32Array(this.grassCount * 3), 3);
        instanceMesh.instanceColor.needsUpdate = true;
    }

    animate() {
        this.controls.update();

        if (this.grassStuff) {
            this.grassStuff.mesh.material.uniforms.fTime.value = this.grassStuff.clock.getElapsedTime();
        }
        this.renderer.render(this.scene, this.camera);
    }
}

class GrassMaterial extends THREE.ShaderMaterial {
    uniforms = {
        fTime: { value: 0.0 },
        vPlayerPosition: { value: new THREE.Vector3(0.0, -1.0, 0.0) },
        fPlayerColliderRadius: { value: 1.1 },
    };

    vertexShader = `
        uniform float fTime;
        uniform vec3 vPlayerPosition;
        uniform float fPlayerColliderRadius;

        varying float fDistanceFromGround;
        varying vec3 vInstanceColor;

        float rand(float n){return fract(sin(n) * 43758.5453123);}
        float rand(vec2 n) {
            return fract(sin(dot(n, vec2(12.9898, 4.1414))) * 43758.5453);
        }

        float createNoise(vec2 n) {
            vec2 d = vec2(0.0, 1.0);
            vec2 b = floor(n);
            vec2 f = smoothstep(vec2(0.0), vec2(1.0), fract(n));
            return mix(mix(rand(b), rand(b + d.yx), f.x), mix(rand(b + d.xy), rand(b + d.yy), f.x), f.y);
        }

        vec3 localToWorld(vec3 target) {
            return (modelMatrix * instanceMatrix * vec4(target, 1.0)).xyz;
        }

        void main() {
            fDistanceFromGround = max(0.0, position.y);
            vInstanceColor = instanceColor;

            vec3 worldPosition = localToWorld(position);
            float noise = createNoise(vec2(position.x, position.z)) * 0.6 + 0.4;
            float distanceFromPlayer = length(vPlayerPosition - worldPosition);

            vec3 sway = 0.1 * vec3(
                cos(fTime) * noise * fDistanceFromGround,
                0.0,
                0.0
            );

            vec3 vNormal = normalize(vPlayerPosition - worldPosition);
            vNormal.y = abs(vNormal.y);
            float fOffset = fPlayerColliderRadius - distanceFromPlayer;
            vec3 vPlayerOffset = -(vNormal * fOffset);

            worldPosition += mix(
                sway * min(1.0, distanceFromPlayer / 4.0),
                vPlayerOffset,
                float(distanceFromPlayer < fPlayerColliderRadius)
            );

            gl_Position = projectionMatrix * viewMatrix * vec4(worldPosition, 1.0);
        }
    `;

    fragmentShader = `
        varying float fDistanceFromGround;
        varying vec3 vInstanceColor;

        void main() {
            vec3 colorDarkest = vec3(24.0 / 255.0, 30.0 / 255.0, 41.0 / 255.0);
            vec3 colorBrightest = vec3(88.0 / 255.0, 176.0 / 255.0, 110.0 / 255.0);
            vec3 color = mix(colorDarkest, colorBrightest, fDistanceFromGround / 2.0);
            color = clamp(color, 0.0, 1.0);
            gl_FragColor = vec4(color, 1.);
        }
    `;

    constructor(props) {
        super(props);
    }
}

(async () => {
    const app = new App();
    await app.createGrass(); // hanya dipanggil sekali
})();


</script>
</body>

</html>